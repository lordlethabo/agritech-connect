<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Marketplace â€“ AgriTech Connect</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      margin: 0; padding: 20px;
      background: #f4fff1;
      color: #333;
    }
    h1 {
      text-align: center;
      color: #2e7d32;
    }
    #toggleBtn {
      background: #81c784;
      border: none;
      color: white;
      padding: 10px 20px;
      margin: 20px auto;
      display: block;
      border-radius: 10px;
      cursor: pointer;
      font-weight: bold;
    }
    #productsContainer {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 20px;
      margin-top: 30px;
    }
    .product {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      overflow: hidden;
      transition: transform 0.3s ease;
    }
    .product:hover {
      transform: translateY(-5px);
    }
    .product img {
      width: 100%;
      height: 180px;
      object-fit: cover;
    }
    .product-info {
      padding: 15px;
    }
    .product-title {
      font-weight: bold;
      font-size: 16px;
      margin-bottom: 8px;
      color: #2e7d32;
    }
    .product-price {
      color: #558b2f;
      font-weight: bold;
    }
    .action-btn {
      display: inline-block;
      margin-top: 10px;
      padding: 6px 14px;
      background-color: #388e3c;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    .action-btn.delete {
      background-color: #e53935;
      margin-left: 10px;
    }
  </style>
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
</head>
<body>

<h1>ðŸŒ½ Marketplace</h1>
<button id="toggleBtn">Switch to Seller Mode</button>

<div id="productsContainer"></div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBLHgzcY_VdE_F5BzEahc6EY5dfSRgLeDw",
    authDomain: "agritechconnect.firebaseapp.com",
    projectId: "AgriTechConnect",
    storageBucket: "agritechconnect.appspot.com",
    messagingSenderId: "1027312049739",
    appId: "1:1027312049739:web:d4475b869a027b767cb7ce"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  const productsContainer = document.getElementById("productsContainer");
  const toggleBtn = document.getElementById("toggleBtn");

  let currentUser = null;
  let currentUserData = null;
  let currentMode = "buyer"; // default

  auth.onAuthStateChanged(async user => {
    if (!user) return window.location.href = "index.html";
    currentUser = user;

    const doc = await db.collection("users").doc(user.uid).get();
    currentUserData = doc.exists ? doc.data() : {};

    loadMarketplace();
  });

  toggleBtn.addEventListener("click", () => {
    currentMode = currentMode === "buyer" ? "seller" : "buyer";
    toggleBtn.textContent = `Switch to ${currentMode === "buyer" ? "Seller" : "Buyer"} Mode`;
    loadMarketplace();
  });

  async function loadMarketplace() {
    productsContainer.innerHTML = "Loading...";

    const snapshot = await db.collection("products").orderBy("createdAt", "desc").get();
    productsContainer.innerHTML = "";

    snapshot.forEach(doc => {
      const data = doc.data();
      const card = document.createElement("div");
      card.className = "product";

      card.innerHTML = `
        <img src="${data.imageUrl}" alt="${data.title}" />
        <div class="product-info">
          <div class="product-title">${data.title}</div>
          <div class="product-price">R${data.price}</div>
        </div>
      `;

      if (currentMode === "buyer") {
        const btn = document.createElement("button");
        btn.className = "action-btn";
        btn.textContent = "Add to Cart";
        btn.onclick = () => alert("Added to cart!");
        card.querySelector(".product-info").appendChild(btn);
      }

      if (currentMode === "seller" && data.ownerId === currentUser.uid) {
        const editBtn = document.createElement("button");
        editBtn.className = "action-btn";
        editBtn.textContent = "Edit";
        editBtn.onclick = () => alert("Edit feature coming soon");

        const delBtn = document.createElement("button");
        delBtn.className = "action-btn delete";
        delBtn.textContent = "Delete";
        delBtn.onclick = async () => {
          if (confirm("Are you sure you want to delete this item?")) {
            await db.collection("products").doc(doc.id).delete();
            loadMarketplace();
          }
        };

        card.querySelector(".product-info").appendChild(editBtn);
        card.querySelector(".product-info").appendChild(delBtn);
      }

      productsContainer.appendChild(card);
    });
  }
</script>

</body>
</html>
