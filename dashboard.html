<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AgriTech Connect – Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      margin: 0;
      background: #f4fff1;
      color: #2e7d32;
    }
    header {
      background: #81c784;
      color: white;
      padding: 15px 30px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    header h1 {
      margin: 0;
      font-weight: 600;
    }
    #signOutBtn {
      background: #66bb6a;
      border: none;
      color: white;
      padding: 10px 18px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
    }
    #signOutBtn:hover {
      background: #4caf50;
    }
    main {
      padding: 30px;
      max-width: 900px;
      margin: 0 auto;
    }
    .profile-section {
      background: white;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      margin-bottom: 30px;
      display: flex;
      align-items: center;
      gap: 20px;
    }
    .profile-pic {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid #81c784;
    }
    .profile-info {
      flex-grow: 1;
    }
    .profile-info h2 {
      margin: 0 0 6px;
    }
    .input-group {
      margin-top: 10px;
    }
    input[type="file"], input[type="text"] {
      padding: 8px;
      border-radius: 8px;
      border: 1px solid #ccc;
      width: 100%;
      font-size: 14px;
    }
    button.upload-btn {
      margin-top: 10px;
      padding: 10px 15px;
      background-color: #81c784;
      border: none;
      color: white;
      font-weight: 600;
      border-radius: 12px;
      cursor: pointer;
    }
    button.upload-btn:hover {
      background-color: #66bb6a;
    }
    section {
      background: white;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 30px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }
    section h3 {
      margin-top: 0;
    }
    #message {
      margin-top: 10px;
      color: red;
      font-weight: 600;
    }
  </style>

  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>
</head>
<body>
  <header>
    <h1>AgriTech Connect</h1>
    <button id="signOutBtn" aria-label="Sign out">Sign Out</button>
  </header>
  <main>
    <section class="profile-section" aria-label="User Profile">
      <img id="profilePic" src="default-profile.png" alt="Profile Picture" class="profile-pic" />
      <div class="profile-info">
        <h2 id="displayName">Loading...</h2>
        <p id="emailDisplay"></p>
        <p><strong>Role:</strong> <span id="roleDisplay">Loading...</span></p>
        <div class="input-group">
          <label for="profileHeading">Profile Heading / Bio:</label>
          <input type="text" id="profileHeading" placeholder="Write a heading or bio for your profile" />
          <button class="upload-btn" id="saveHeadingBtn">Save Heading</button>
          <div id="headingMsg" role="alert" aria-live="polite"></div>
        </div>
        <div class="input-group">
          <label for="profileImageUpload">Upload Profile Picture:</label>
          <input type="file" id="profileImageUpload" accept="image/*" />
          <button class="upload-btn" id="uploadProfilePicBtn">Upload Picture</button>
          <div id="uploadMsg" role="alert" aria-live="polite"></div>
        </div>
      </div>
    </section>

    <!-- Buyer Section -->
    <section id="buyerSection" style="display:none;">
      <h3>🛒 Marketplace</h3>
      <p>Here you can browse produce and livestock for sale from sellers.</p>
      <!-- Marketplace dynamic content will go here -->
    </section>

    <!-- Seller Section -->
    <section id="sellerSection" style="display:none;">
      <h3>📦 Your Products & Livestock for Sale</h3>
      <p>Upload photos and details of the products or livestock you want to sell.</p>
      <!-- Upload & product management UI to be added -->
    </section>

    <!-- Mentor Section -->
    <section id="mentorSection" style="display:none;">
      <h3>🤝 Mentorship</h3>
      <p>Access mentorship requests and provide guidance to farmers.</p>
      <!-- Mentorship dashboard content here -->
    </section>

    <!-- Admin Section -->
    <section id="adminSection" style="display:none;">
      <h3>⚙️ Admin Panel</h3>
      <p>Manage users, products, and site content.</p>
      <!-- Admin management tools here -->
    </section>
  </main>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBLHgzcY_VdE_F5BzEahc6EY5dfSRgLeDw",
      authDomain: "agritechconnect.firebaseapp.com",
      projectId: "agritechconnect-1d52b",
      storageBucket: "agritechconnect.appspot.com",
      messagingSenderId: "1027312049739",
      appId: "1:1027312049739:web:d4475b869a027b767cb7ce"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();

    const profilePic = document.getElementById("profilePic");
    const displayNameEl = document.getElementById("displayName");
    const emailDisplay = document.getElementById("emailDisplay");
    const roleDisplay = document.getElementById("roleDisplay");
    const profileHeadingInput = document.getElementById("profileHeading");
    const saveHeadingBtn = document.getElementById("saveHeadingBtn");
    const headingMsg = document.getElementById("headingMsg");
    const profileImageUpload = document.getElementById("profileImageUpload");
    const uploadProfilePicBtn = document.getElementById("uploadProfilePicBtn");
    const uploadMsg = document.getElementById("uploadMsg");

    const buyerSection = document.getElementById("buyerSection");
    const sellerSection = document.getElementById("sellerSection");
    const mentorSection = document.getElementById("mentorSection");
    const adminSection = document.getElementById("adminSection");

    let currentUserUID = null;
    let userDocRef = null;

    // Redirect if not logged in, else load user info
    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        window.location.href = "index.html";
        return;
      }
      currentUserUID = user.uid;
      userDocRef = db.collection("users").doc(currentUserUID);

      // Load user profile from Firestore
      const doc = await userDocRef.get();
      if (!doc.exists) {
        // If no user doc, create default
        await userDocRef.set({
          displayName: user.displayName || "Unknown User",
          email: user.email,
          role: "buyer",
          photoURL: user.photoURL || "",
          profileHeading: "",
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        displayUserProfile(user.displayName || "Unknown User", user.email, "buyer", user.photoURL || "", "");
        showRoleSections("buyer");
      } else {
        const data = doc.data();
        displayUserProfile(data.displayName, data.email, data.role, data.photoURL, data.profileHeading || "");
        showRoleSections(data.role);
      }

    });

    // Display profile info on page
    function displayUserProfile(name, email, role, photoURL, heading) {
      displayNameEl.textContent = name;
      emailDisplay.textContent = email;
      roleDisplay.textContent = role;
      profileHeadingInput.value = heading;
      profilePic.src = photoURL && photoURL !== "" ? photoURL : "default-profile.png";
    }

    // Show relevant sections based on role
    function showRoleSections(role) {
      buyerSection.style.display = "none";
      sellerSection.style.display = "none";
      mentorSection.style.display = "none";
      adminSection.style.display = "none";

      if (role === "buyer") buyerSection.style.display = "block";
      if (role === "seller") sellerSection.style.display = "block";
      if (role === "mentor") mentorSection.style.display = "block";
      if (role === "admin") adminSection.style.display = "block";

      // Users can have multiple roles; expand this if you want multi-role UI display
    }

    // Save profile heading to Firestore
    saveHeadingBtn.addEventListener("click", async () => {
      const newHeading = profileHeadingInput.value.trim();
      headingMsg.style.color = "red";
      headingMsg.textContent = "";

      if (!newHeading) {
        headingMsg.textContent = "Heading cannot be empty.";
        return;
      }
      try {
        await userDocRef.update({ profileHeading: newHeading });
        headingMsg.style.color = "green";
        headingMsg.textContent = "Heading updated successfully!";
      } catch (error) {
        headingMsg.textContent = "Error updating heading: " + error.message;
      }
    });

    // Upload profile picture
    uploadProfilePicBtn.addEventListener("click", () => {
      uploadMsg.style.color = "red";
      uploadMsg.textContent = "";

      const file = profileImageUpload.files[0];
      if (!file) {
        uploadMsg.textContent = "Please select an image file first.";
        return;
      }

      const storageRef = storage.ref();
      const profilePicRef = storageRef.child(`profilePics/${currentUserUID}_${file.name}`);

      // Upload file
      const uploadTask = profilePicRef.put(file);

      uploadTask.on('state_changed', 
        (snapshot) => {
          // Optional: Can add progress bar here
        }, 
        (error) => {
          uploadMsg.textContent = "Upload failed: " + error.message;
        }, 
        () => {
          uploadTask.snapshot.ref.getDownloadURL().then(async (downloadURL) => {
            // Update Firestore and Firebase user profile photoURL
            await userDocRef.update({ photoURL: downloadURL });
            await auth.currentUser.updateProfile({ photoURL: downloadURL });

            profilePic.src = downloadURL;
            uploadMsg.style.color = "green";
            uploadMsg.textContent = "Profile picture updated!";
          });
        }
      );
    });

    // Sign out
    document.getElementById("signOutBtn").addEventListener("click", () => {
      auth.signOut().then(() => {
        window.location.href = "index.html";
      });
    });
  </script>
</body>
</html>
