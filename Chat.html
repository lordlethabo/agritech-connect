<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AgriTech Connect – Community Chat</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
  <style>
    #chatMessages { height: 400px; overflow-y: auto; padding: 10px; background: white; border-radius: 8px; color: black; }
    .message { margin-bottom: 10px; background-color: #f0fdf4; padding: 8px; border-radius: 8px; }
    .message strong { color: #059669; }
    .badge { font-size: 0.75rem; background-color: #bbf7d0; color: #065f46; padding: 2px 6px; border-radius: 9999px; margin-left: 8px; }
  </style>
</head>
<body class="bg-gray-100 text-gray-900">
  <main class="max-w-2xl mx-auto p-6">
    <h1 class="text-2xl font-bold mb-4">💬 Community Chat</h1>

    <label for="roomSelector" class="block mb-2">Select Room:</label>
    <select id="roomSelector" class="mb-4 p-2 border rounded">
      <option value="general">🌍 General</option>
      <option value="youth">🌱 Youth Farmers</option>
      <option value="mentors">👩🏾‍🏫 Mentors</option>
    </select>

    <div id="chatMessages"></div>

    <form id="chatForm" class="mt-4 flex gap-2">
      <input id="messageInput" type="text" placeholder="Type your message..." class="flex-1 p-2 border rounded" required />
      <button type="submit" class="bg-green-700 text-white px-4 rounded hover:bg-green-800">Send</button>
    </form>
  </main>

  <audio id="notifSound" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBLHgzcY_VdE_F5BzEahc6EY5dfSRgLeDw",
      authDomain: "agritechconnect-1d52b.firebaseapp.com",
      projectId: "agritechconnect-1d52b"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const chatMessages = document.getElementById("chatMessages");
    const chatForm = document.getElementById("chatForm");
    const messageInput = document.getElementById("messageInput");
    const roomSelector = document.getElementById("roomSelector");
    const notifSound = document.getElementById("notifSound");

    let currentUser = null;
    let currentRoom = "general";
    let unsubscribe = null;

    auth.onAuthStateChanged(async (user) => {
      if (!user) return window.location.href = "index.html";
      currentUser = user;
      loadMessages();
    });

    roomSelector.addEventListener("change", () => {
      currentRoom = roomSelector.value;
      if (unsubscribe) unsubscribe();
      loadMessages();
    });

    async function loadMessages() {
      const roomRef = db.collection("chatRooms").doc(currentRoom).collection("messages").orderBy("timestamp", "asc");
      unsubscribe = roomRef.onSnapshot(async (snapshot) => {
        chatMessages.innerHTML = "";
        for (const doc of snapshot.docs) {
          const msg = doc.data();
          const userDoc = await db.collection("users").doc(msg.userId).get();
          const userData = userDoc.data();
          const role = userData?.role || "User";

          const messageEl = document.createElement("div");
          messageEl.classList.add("message");
          messageEl.innerHTML = `<strong>${msg.userName}</strong><span class='badge'>${role}</span>: ${msg.text}`;
          chatMessages.appendChild(messageEl);
        }
        chatMessages.scrollTop = chatMessages.scrollHeight;
        if (!document.hasFocus()) notifSound.play();
      });
    }

    chatForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!messageInput.value.trim()) return;

      await db.collection("chatRooms").doc(currentRoom).collection("messages").add({
        userId: currentUser.uid,
        userName: currentUser.displayName || currentUser.email,
        text: messageInput.value.trim(),
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });
      messageInput.value = "";
    });
  </script>
</body>
</html>
